<h1>การติดตั้งและใช้งาน Node-RED (และการเลือก MQTT Broker)</h1>
<p>
    Node-RED คือเครื่องมือเขียนโปรแกรมแบบ Flow-based ที่ทำให้เราสามารถเชื่อมต่ออุปกรณ์ Hardware (เช่น ESP32), APIs, และบริการออนไลน์ต่างๆ เข้าด้วยกันได้ง่ายๆ ผ่านหน้าเว็บ
</p>
<p>
    ก่อนจะติดตั้ง Node-RED เราจำเป็นต้องมี "ตลาดกลาง" สำหรับรับส่งข้อมูล IoT ก่อน ซึ่งเรียกว่า **MQTT Broker** ในคู่มือนี้ เราจะเปรียบเทียบและติดตั้ง Broker สองตัวที่นิยมที่สุดคือ **Mosquitto** และ **EMQX**
</p>

<hr style="margin: 40px 0;">

<h2>1. เลือกและติดตั้ง MQTT Broker (Mosquitto vs EMQX)</h2>
<p>
    คุณจำเป็นต้องเลือกติดตั้ง Broker **เพียง 1 ตัว** เท่านั้น เพื่อใช้เป็นศูนย์กลาง MQTT ของคุณ
</p>

<h3>เปรียบเทียบ: Mosquitto vs EMQX</h3>
<table class="spec-table">
    <thead>
        <tr>
            <th>คุณสมบัติ</th>
            <th>Mosquitto (Eclipse)</th>
            <th>EMQX</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><strong>ขนาดและการใช้งาน</strong></td>
            <td>เบามาก (Lightweight) เหมาะสำหรับโปรเจกต์ขนาดเล็กถึงกลาง หรือเครื่องที่มีทรัพยากรจำกัด</td>
            <td>ทรงพลัง (Powerful) ออกแบบมาสำหรับระบบขนาดใหญ่ (Massive Scale) และการทำ Clustering</td>
        </tr>
        <tr>
            <td><strong>ทรัพยากร (RAM/CPU)</strong></td>
            <td>ต่ำมาก</td>
            <td>ปานกลางถึงสูง</td>
        </tr>
        <tr>
            <td><strong>การจัดการ (Management)</strong></td>
            <td>ผ่านไฟล์คอนฟิก (`mosquitto.conf`) และ Terminal เท่านั้น</td>
            <td>ผ่านไฟล์คอนฟิก และมี **Web UI Dashboard** ในตัวที่ยอดเยี่ยม</td>
        </tr>
        <tr>
            <td><strong>Web UI ในตัว</strong></td>
            <td><strong style="color: #c0392b;">ไม่มี</strong></td>
            <td><strong style="color: #28a745;">มี</strong> (นี่คือจุดเด่นหลัก)</td>
        </tr>
        <tr>
            <td><strong>แนะนำสำหรับ</strong></td>
            <td>การเริ่มต้น, การทดสอบ, Homelab, หรือเมื่อต้องการความเรียบง่ายและประหยัดทรัพยากร</td>
            <td>การใช้งานจริงจัง, ต้องการ Monitoring แบบ Real-time, หรือต้องการ UI สำหรับจัดการ</td>
        </tr>
    </tbody>
</table>

<hr style="margin: 20px 0;">

<h3>1.1 ตัวเลือก A: Mosquitto (เบาและง่าย)</h3>
<p>
    หากคุณต้องการ Broker ที่เล็กและทำงานได้ดี ให้ใช้ตัวนี้
</p>
<ol>
    <li><strong>สร้าง Volumes:</strong>
        <pre><code>docker volume create mosquitto_config
docker volume create mosquitto_data
docker volume create mosquitto_log</code></pre>
    </li>
    <li><strong>สร้าง Stack (`mosquitto_stack`):</strong>
        <pre><code>networks:
  app_net:
    external: true

volumes:
  mosquitto_config:
    external: true
  mosquitto_data:
    external: true
  mosquitto_log:
    external: true

services:
  mosquitto:
    image: eclipse-mosquitto:latest
    container_name: mosquitto
    restart: unless-stopped
    ports:
      - "1883:1883"  # MQTT Port
      - "9001:9001"  # MQTT over WebSockets
    volumes:
      - mosquitto_config:/mosquitto/config
      - mosquitto_data:/mosquitto/data
      - mosquitto_log:/mosquitto/log
    networks:
      - app_net
</code></pre>
    </li>
</ol>

<hr style="margin: 20px 0;">

<h3>1.2 ตัวเลือก B: EMQX (ทรงพลังและมี UI Dashboard)</h3>
<p>
    หากคุณต้องการ Broker ที่มี Dashboard สวยงามสำหรับดูสถานะ, จัดการ Client, และทดสอบการเชื่อมต่อ ให้ใช้ตัวนี้
</p>
<ol>
    <li><strong>สร้าง Volumes:</strong>
        <pre><code>docker volume create emqx_data
docker volume create emqx_log</code></pre>
    </li>
    <li><strong>สร้าง Stack (`emqx_stack`):</strong>
        <pre><code>networks:
  app_net:
    external: true

volumes:
  emqx_data:
    external: true
  emqx_log:
    external: true

services:
  emqx:
    image: emqx/emqx:latest
    container_name: emqx
    restart: unless-stopped
    ports:
      - "1883:1883"     # MQTT Port
      - "8083:8083"     # MQTT over WebSockets
      - "18083:18083"   # Web UI Dashboard (สำคัญ!)
    volumes:
      - emqx_data:/opt/emqx/data
      - emqx_log:/opt/emqx/log
    networks:
      - app_net
</code></pre>
    </li>
</ol>

<h3>1.3 (EMQX) การใช้งาน UI Dashboard เบื้องต้น</h3>
<p>
    หลังจาก Deploy Stack EMQX สำเร็จ:
</p>
<ol>
    <li>
        <strong>เข้าสู่หน้า Dashboard:</strong><br>
        เปิดเบราว์เซอร์ไปที่ <code>http://[IP_SERVER_ของคุณ]:18083</code>
    </li>
    <li>
        <strong>ล็อกอิน:</strong><br>
        ใช้ข้อมูลเริ่มต้น (Default):
        <ul>
            <li><strong>Username:</strong> <code>admin</code></li>
            <li><strong>Password:</strong> <code>public</code></li>
        </ul>
        <div class="image-container">
            
            <p>หน้าล็อกอินของ EMQX Dashboard</p>
        </div>
    </li>
    <li>
        <strong>สำรวจ Dashboard:</strong><br>
        คุณจะเห็นหน้าจอหลักที่แสดงสถานะการเชื่อมต่อ, จำนวน Topics, และข้อความที่วิ่งในระบบแบบ Real-time
        <div class="image-container">
            
            <p>หน้า Dashboard หลัก แสดงภาพรวมของ Broker</p>
        </div>
    </li>
    <li>
        <strong>ทดสอบการเชื่อมต่อ (WebSocket Tool):</strong><br>
        EMQX มีเครื่องมือทดสอบ MQTT Client ในตัว:
        <ul>
            <li>ไปที่เมนู <strong>Diagnosis</strong> > <strong>WebSocket Client</strong></li>
            <li>คลิก <strong>Connect</strong></li>
            <li>ในส่วน "Subscription" ให้พิมพ์ Topic (เช่น <code>vecskill</code>) แล้วคลิก <strong>Subscribe</strong></li>
            <li>ในส่วน "Publish" ให้พิมพ์ Topic (<code>vecskill</code>) และ Payload (<code>{"test": "hello"}</code>) แล้วคลิก <strong>Publish</strong></li>
        </ul>
        คุณจะเห็นข้อความที่คุณเพิ่ง Publish ปรากฏในกล่อง "Messages" ทันที
        <div class="image-container">
            
            <p>เครื่องมือ WebSocket Client ในตัวสำหรับทดสอบ Publish/Subscribe</p>
        </div>
    </li>
</ol>

<hr style="margin: 40px 0;">

<h2>2. การติดตั้ง Node-RED</h2>
<p>
    หลังจากคุณเลือกและติดตั้ง MQTT Broker (Mosquitto หรือ EMQX) เรียบร้อยแล้ว ขั้นต่อไปคือการติดตั้ง Node-RED
</p>
<h3>2.1 สร้าง Volume</h3>
<pre><code>docker volume create nodered_data</code></pre>
<h3>2.2 สร้าง Stack (`nodered_stack`)</h3>
<pre><code>networks:
  app_net:
    external: true

volumes:
  nodered_data:
    external: true

services:
  node-red:
    image: nodered/node-red:latest
    container_name: node-red
    restart: unless-stopped
    environment:
      - TZ=Asia/Bangkok
    ports:
      - "1880:1880" # Web Admin UI
    volumes:
      - nodered_data:/data
    networks:
      - app_net
</code></pre>

<hr style="margin: 40px 0;">

<h2>3. การใช้งานเบื้องต้น (เชื่อมต่อ Node-RED กับ Broker)</h2>
<p>
    ทำตามขั้นตอนเหล่านี้เพื่อรับข้อมูลจาก ESP32 (ที่ส่งมาที่ Topic <code>vecskill</code>)
</p>
<ol>
    <li>
        <strong>เข้าสู่หน้า Node-RED:</strong> <code>http://[IP_SERVER_ของคุณ]:1880</code>
    </li>
    <li>
        <strong>ลาก Node `mqtt in` มาวาง</strong>
    </li>
    <li>
        <strong>ตั้งค่า `mqtt in`:</strong>
        <ul>
            <li><strong>Server:</strong> คลิกไอคอนดินสอเพื่อ "Add new mqtt-broker"
                <ul>
                    <li><strong>Server:</strong> พิมพ์ <code>mosquitto</code> หรือ <code>emqx</code> (ขึ้นอยู่กับว่าคุณติดตั้งตัวไหน)</li>
                    <li><strong>Port:</strong> <code>1883</code></li>
                    <li>คลิก "Add"</li>
                </ul>
            </li>
            <li><strong>Topic:</strong> พิมพ์ <code>vecskill</code></li>
            <li><strong>Output:</strong> เลือก <strong>"a parsed JSON object"</strong></li>
            <li>คลิก "Done"</li>
        </ul>
        <div class="image-container">
            
            <p>การตั้งค่า Node `mqtt in` ให้เชื่อมต่อกับ Broker (mosquitto หรือ emqx)</p>
        </div>
    </li>
    <li>
        <strong>ลาก Node `debug` มาวาง</strong> และเชื่อมต่อเส้นจาก `mqtt in`
    </li>
    <li>
        <strong>Deploy</strong> และตรวจสอบหน้าต่าง Debug คุณจะเห็นข้อมูล JSON จาก ESP32
    </li>
</ol>

<hr style="margin: 40px 0;">

<h2>4. การตั้งค่าความปลอดภัย (เปิดใช้งาน Login)</h2>
<p>
    (ขั้นตอนนี้เหมือนเดิม) เราจะตั้งค่าให้ Node-RED มีระบบล็อกอิน
</p>
<ol>
    <li>
        <strong>เข้า Shell ของ `node-red` Container</strong> (ผ่าน Portainer หรือ <code>docker exec -it node-red bash</code>)
    </li>
    <li>
        <strong>ติดตั้ง `node-red-admin`:</strong>
        <pre><code>npm install -g node-red-admin</code></pre>
    </li>
    <li>
        <strong>สร้างรหัสผ่าน Hash:</strong> (ป้อนรหัสผ่านที่คุณต้องการ)
        <pre><code>node-red-admin hash-pw</code></pre>
        คัดลอกค่า Hash ที่ได้ (เช่น <code>$2b$08$...</code>)
    </li>
    <li>
        <strong>แก้ไขไฟล์ `settings.js`:</strong>
        <pre><code>nano /data/settings.js</code></pre>
    </li>
    <li>
        <strong>เปิดใช้งาน `adminAuth`:</strong><br>
        ค้นหา <code>//adminAuth: { ...</code> แล้วลบเครื่องหมาย <code>//</code> ออก และแก้ไข Username/Password:
        <pre><code class="language-javascript">adminAuth: {
    type: "credentials",
    users: [{
        username: "admin",
        password: "[HASHED_PASSWORD_HERE]", // วางค่า Hash ที่คัดลอกมา
        permissions: "*"
    }]
},
</code></pre>
    </li>
    <li>
        <strong>รีสตาร์ท Container:</strong> <code>exit</code> ออกจาก Shell แล้วรีสตาร์ท Container `node-red` ผ่าน Portainer
    </li>
</ol>
<p>
    เมื่อรีเฟรชหน้า <code>:1880</code> อีกครั้ง คุณจะพบกับหน้าล็อกอิน
</p>