<h1>การใช้งาน GitLab Runner</h1>
<p>
    GitLab Runner คือ "ผู้ปฏิบัติงาน" ที่จะทำตามคำสั่งในไฟล์ <code>.gitlab-ci.yml</code> ของเรา มันเป็นโปรแกรมที่เราติดตั้งแยกต่างหากจาก GitLab Server โดย Runner สามารถติดตั้งได้บนเครื่องเซิร์ฟเวอร์เดียวกัน, บนเครื่องอื่น, หรือแม้กระทั่งบน Cloud ก็ได้
</p>
<p>
    เมื่อเรา Push โค้ดใหม่, GitLab Server จะตรวจพบและส่ง "งาน" (Job) ไปให้ Runner ที่ว่างอยู่เป็นผู้ทำ เมื่อ Runner ทำงานเสร็จ ก็จะส่งผลลัพธ์ (Log, Artifacts) กลับไปยัง GitLab Server
</p>

<h3>ประเภทของ Runner Executors</h3>
<p>
    Executor คือสภาพแวดล้อมที่ Runner จะใช้ในการรัน Job ของเรา มีหลายประเภทให้เลือก แต่ประเภทที่ทรงพลังและนิยมใช้กันมากที่สุดคือ:
</p>
<ul>
    <li><strong>Shell Executor:</strong> รันคำสั่งโดยตรงบนเครื่องที่ติดตั้ง Runner เหมาะกับงานง่ายๆ แต่มีความเสี่ยงด้านความปลอดภัยและอาจทำให้เครื่องรกได้</li>
    <li><strong>Docker Executor:</strong> รันแต่ละ Job ภายใน Docker Container ที่แยกขาดจากกัน วิธีนี้สะอาด, ปลอดภัย, และทำซ้ำได้ง่าย เพราะเราสามารถเลือก Docker Image ที่มีเครื่องมือที่จำเป็นสำหรับ Job นั้นๆ ได้เอง <strong>(เป็นวิธีที่เราจะใช้ในคู่มือนี้)</strong></li>
</ul>

<hr style="margin: 40px 0;">

<h2>ส่วนที่ 1: การติดตั้ง GitLab Runner ผ่าน Docker</h2>
<p>
    วิธีที่ดีที่สุดในการติดตั้ง Runner คือการรันมันในฐานะ Docker Container เช่นกัน ซึ่งจะทำให้การจัดการง่ายและเป็นระเบียบ
</p>
<p style="background-color: #fff3cd; border-left: 5px solid #ffeeba; padding: 15px;">
    <strong>สำคัญ:</strong> เราจะใช้วิธีการเชื่อมต่อ Docker Socket ของเครื่อง Server เข้าไปใน Runner Container (<code>-v /var/run/docker.sock:/var/run/docker.sock</code>) วิธีนี้ทำให้ Runner สามารถใช้คำสั่ง Docker ของเครื่อง Host ได้โดยตรง ซึ่งมีข้อดีคือ Runner จะรับรู้การตั้งค่า <code>daemon.json</code> ของเราโดยอัตโนมัติ ทำให้มันสามารถเชื่อมต่อกับ <code>registry.vecskill.ovec:5000</code> ได้ทันทีโดยไม่ต้องตั้งค่าเพิ่มเติม
</p>

<h3>วิธีที่ 1: ติดตั้งผ่าน Docker Command Line</h3>
<ol>
    <li>
        <strong>สร้างโฟลเดอร์สำหรับเก็บคอนฟิกของ Runner:</strong>
        <pre><code>sudo mkdir -p /srv/gitlab-runner/config</code></pre>
    </li>
    <li>
        <strong>รัน GitLab Runner Container:</strong><br>
        เราจะให้ Runner อยู่ใน Network <code>app_net</code> เดียวกันกับ GitLab และ Registry
        <pre><code>sudo docker run -d --name gitlab-runner --restart always \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -v /srv/gitlab-runner/config:/etc/gitlab-runner \
  --network app_net \
  gitlab/gitlab-runner:latest</code></pre>
    </li>
</ol>


<h3>วิธีที่ 2: ติดตั้งผ่าน Portainer Stack (วิธีแนะนำ)</h3>
<p>
    คุณสามารถสร้าง Stack ใหม่สำหรับ Runner หรือจะเพิ่ม Service นี้เข้าไปใน Stack ของ GitLab เดิมก็ได้ ในตัวอย่างนี้เราจะสร้างเป็น Stack ใหม่
</p>
<p>ไปที่ <strong>Stacks > + Add stack</strong>, ตั้งชื่อ (เช่น `runner-stack`) แล้วใช้โค้ด Docker Compose นี้:</p>
<pre><code>version: '3.8'

services:
  runner:
    image: gitlab/gitlab-runner:latest
    container_name: gitlab-runner
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /srv/gitlab-runner/config:/etc/gitlab-runner
    networks:
      - app_net

networks:
  app_net:
    external: true
</code></pre>
<p>จากนั้นคลิก <strong>Deploy the stack</strong></p>

<hr style="margin: 40px 0;">

<h2>ส่วนที่ 2: การลงทะเบียน (Register) Runner</h2>
<p>
    หลังจากที่ Runner Container ทำงานแล้ว เราต้อง "ลงทะเบียน" มันกับ GitLab Server เพื่อให้ทั้งสองรู้จักกัน
</p>
<ol>
    <li>
        <strong>เตรียมข้อมูลสำหรับลงทะเบียน:</strong><br>
        คุณจะต้องใช้ข้อมูล 2 อย่างนี้จาก GitLab UI ของคุณ:
        <ul>
            <li><strong>GitLab URL:</strong> <code>http://gitlab.vecskill.ovec</code></li>
            <li><strong>Registration Token:</strong> ไปที่ <strong>Admin Area</strong> (ไอคอนประแจ) > <strong>CI/CD</strong> > <strong>Runners</strong> แล้วคัดลอก Token มา (ดูรูปในบทที่ 4)</li>
        </ul>
    </li>
    <li>
        <strong>เข้าสู่ Shell ของ Runner Container และรันคำสั่ง Register:</strong>
        <pre><code>sudo docker exec -it gitlab-runner gitlab-runner register</code></pre>
    </li>
    <li>
        <strong>ตอบคำถามในกระบวนการลงทะเบียน:</strong><br>
        ระบบจะถามคำถามทีละข้อ ให้คุณกรอกข้อมูลตามนี้:
        <pre><code># 1. กรอก GitLab URL ของคุณ
Enter the GitLab instance URL (for example, https://gitlab.com/):
<font color="#3498db">http://gitlab.vecskill.ovec</font>

# 2. กรอก Registration Token ที่คัดลอกมา
Enter the registration token:
<font color="#3498db">[YOUR_TOKEN_HERE]</font>

# 3. ใส่คำอธิบายสำหรับ Runner นี้ (ตั้งชื่ออะไรก็ได้)
Enter a description for the runner:
<font color="#3498db">My Docker Runner</font>

# 4. ใส่ Tags (ใช้สำหรับเลือก Runner ใน .gitlab-ci.yml) กด Enter เพื่อไปต่อ
Enter tags for the runner (comma-separated):
<font color="#3498db">docker,linux</font>

# 5. ใส่บันทึกเพิ่มเติม (ไม่จำเป็น) กด Enter เพื่อไปต่อ
Enter optional maintenance note for the runner:
<font color="#3498db"></font>

# 6. เลือก Executor (สำคัญมาก!) ให้พิมพ์ว่า docker
Enter an executor: docker, parallels, virtualbox, kubernetes, custom, shell, ssh:
<font color="#3498db">docker</font>

# 7. หากเลือก docker, ระบบจะถาม Default Image (คือ Image ที่จะใช้ถ้าใน .gitlab-ci.yml ไม่ได้ระบุ)
Enter the default Docker image (for example, ruby:2.7):
<font color="#3498db">docker:20.10.16</font></code></pre>
        เมื่อตอบคำถามสุดท้ายเสร็จสิ้น จะมีข้อความว่า <code>Runner registered successfully.</code>
    </li>
    <li>
        <strong>ตรวจสอบสถานะใน GitLab UI:</strong><br>
        กลับไปที่หน้า <strong>Admin Area > CI/CD > Runners</strong> คุณจะเห็น Runner ที่เพิ่งลงทะเบียนไปปรากฏขึ้นมาพร้อมกับวงกลมสีเขียว แสดงว่าเชื่อมต่อสำเร็จแล้ว
        <img src="https://i.imgur.com/KxVb6m3.png" alt="GitLab Runner Connected" class="content-image">
    </li>
</ol>


<hr style="margin: 40px 0;">

<h2>ส่วนที่ 3: ทดสอบ Pipeline อีกครั้ง</h2>
<p>
    ตอนนี้เมื่อเรามี "ผู้ปฏิบัติงาน" พร้อมแล้ว เรามาลองสั่งงาน Pipeline ที่เคยค้างอยู่ในสถานะ "pending" กันอีกครั้ง
</p>
<ol>
    <li>
        กลับไปที่โปรเจกต์ <code>my-first-pipeline</code> ของคุณ
    </li>
    <li>
        ไปที่เมนู <strong>CI/CD > Pipelines</strong>
    </li>
    <li>
        คลิกที่ Pipeline ล่าสุดที่สถานะเป็น `pending` หรือ `stuck` จากนั้นคลิกที่ปุ่ม <strong>Retry</strong>
    </li>
    <li>
        คุณจะเห็นว่า Job `build-image` เริ่มทำงาน (สถานะเปลี่ยนเป็น `running`) และเมื่อคลิกเข้าไปดู คุณจะเห็น Log การทำงานจริงที่ Runner กำลังทำตามคำสั่งในไฟล์ <code>.gitlab-ci.yml</code> ของเรา
        <img src="https://i.imgur.com/i9dY6Wn.png" alt="GitLab Pipeline Running" class="content-image">
    </li>
    <li>
        เมื่อ Job ทำงานเสร็จสิ้น (วงกลมสีเขียวและมีเครื่องหมายถูก) ให้คุณลองเข้าไปดูที่ Private Registry ของคุณ (<code>http://[IP_SERVER]:8080</code>) คุณจะพบว่า Docker Image ใหม่ที่ชื่อ <code>my-first-pipeline</code> ถูก Push เข้ามาเก็บไว้เรียบร้อยแล้ว!
    </li>
</ol>

<p>
    <strong>ขอแสดงความยินดีด้วย!</strong> 🎉 คุณได้สร้างระบบ CI/CD อัตโนมัติเต็มรูปแบบสำเร็จแล้ว ตั้งแต่การ Push โค้ด, การสร้าง Docker Image, ไปจนถึงการจัดเก็บ Image ใน Private Registry ของคุณเอง ทั้งหมดนี้ทำงานร่วมกันบน Server ของคุณเอง
</p>